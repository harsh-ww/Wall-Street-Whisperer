import os
os.environ['PERIGON_KEY'] = ''

import services.PerigonService as perigon
from services.exceptions import APIError
import pytest
import requests
from unittest import mock
from tests.unit.mock import MockResponse
from models.Article import Article
import datetime


def mocked_requests_get(*args, **kwargs):

    if kwargs['params']['companyName']=='Apple':
        return MockResponse({'articles': []}, 200)
    
    # Mock responses
    samplePayload = {
        'companyName': 'Tesco',
        'sortBy': 'relevance',
        'size': 3,
        'from': 'IGNORE',
        'language': 'en',
        'apiKey': ''
    }
    # This test is to test the formatting, so ignoring date - there is a separate test for date processing
    kwargs["params"]['from'] = 'IGNORE'
    if kwargs['params'] == samplePayload:
        return MockResponse({"status":200,"numResults":159,"articles":[{"url":"https://wearesouthdevon.com/torbay-hospital-neonatal-unit-receives-premature-baby-clothing-donation-from-tesco/","authorsByline":"WASD Author","articleId":"1ae56fa4f4c94f0b9f48885c9d0d6d4d","clusterId":"01fbe7092ab2424d8654f40f801e14f9","source":{"domain":"wearesouthdevon.com","location":None},"imageUrl":"https://wearesouthdevon.com/wp-content/uploads/2024/03/Baby2-scaled.jpeg","country":"us","language":"en","pubDate":"2024-03-05T08:01:32+00:00","addDate":"2024-03-05T08:09:32.756599+00:00","refreshDate":"2024-03-05T08:09:32.756600+00:00","score":47.587852,"title":"Torbay Hospital neonatal unit receives premature baby clothing donation from Tesco","description":"Torbay Hospital neonatal unit receives premature baby clothing donation from Tesco -","content":"are benefiting from packs of premature baby clothes this winter.\n\nt what can be a difficult ed packs of F&F Premature Baby Essentials to the Tesco to help deliver the\n\nand it can be difficult to find clothing items to fit at such short notice. We want to provide practical help to mums and dads at and help give the babies a stronger start in life.”\n\nfrom the Office for National Statistics , on average 7-10% of babies born in England and Wales are born prematurely across the country, this will receive some of the F&F essentials.\n\n“Having a baby born prematurely can be a really worrying time for so many, and with our hard-working staff across the country continuing to do all they can to provide care and support to premature babies and their families, it is fantastic that Tesco is donating specialist baby clothing to every NHS neonatal unit across England to provide additional help.\n\n“These clothing packs could make a huge difference to tens of thousands of babies and their families who need it most over the next year, and we are extremely grateful to Tesco, and to the Salvation Army, for making this possible.”\n\nWe are happy to be items of clothing to the NHS neo-natal units, which are saving young lives.\n\nProviding this support means The Salvation Army can continue to provide practical help for people in need across the UK. These generous donations provide comfort for the most vulnerable and give these families essentials in their time of need.”\n\ncollect tens of thousands of toys from generous shoppers to help struggling families. And last in to help families struggling with the cost-of-living by donating almost 4,000 new F&F coats to people in need through FareShare, the Salvation Army and the Cottage Family Centre children’s charity in Kirkcaldy.\n\nJuly 2023 saw Tesco launch Stronger Starts: a £5m grant programme, in partnership with Groundwork UK, to give children across the UK a stronger start in life. The grants help schools and children’s groups provide nutritious food and healthy activities that support young people’s physical health and mental wellbeing, such as breakfast clubs or snacks, and equipment for healthy activities. Customers can support their local school and children’s groups by dropping the Tesco blue token they receive at checkout into the relevant voting box as they leave the store.\n\nTesco Head of Communities, said: “Through our Stronger Starts programme, we’re supporting children to get the best possible start in life, whether that’s helping out with their first baby grow or as they grow up, providing funding for nutritious food and activity equipment in schools and community groups where it is needed most.”\n\nYou can join us on our social media pages, follow us on Facebook, X (formerly known as Twitter) and Threads where you can keep up to date with whats going on in South Devon.\n\nGot a news story, blog or press release that you’d like to share or want to advertise with us? Get in touch via email admin@wearesouthdevon.com","medium":"Article","links":["https://wearesouthdevon.com/wp-content/uploads/2024/03/Baby1-scaled.jpeg","https://wearesouthdevon.com/plymouth-boy-needing-kidney-transplant-supports-waiting-to-live-campaign/","http://www.twitter.com/wearesouthdevon.com","http://www.threads.net/wearesouthdevon","https://wearesouthdevon.com/young-man-with-inoperable-brain-tumour-visits-research-centre-where-scientists-are-focused-on-finding-a-cure/","http://www.facebook.com/wearesouthdevon","https://wearesouthdevon.com/assistant-site-manager-shares-her-advice-for-women-entering-the-exciting-world-of-construction/"],"labels":[],"matchedAuthors":[],"claim":"","verdict":"","keywords":[{"name":"premature babies","weight":0.08824135},{"name":"specialist baby clothing","weight":0.087351546},{"name":"premature baby clothing donation","weight":0.0865332},{"name":"premature baby clothes","weight":0.08435164},{"name":"babies","weight":0.08418611},{"name":"young lives","weight":0.08028749},{"name":"activity equipment","weight":0.074170746},{"name":"healthy activities","weight":0.07244991},{"name":"life","weight":0.07044761},{"name":"Tesco","weight":0.06831861}],"topics":[],"categories":[],"entities":[{"data":"Torbay Hospital","type":"ORG","mentions":1},{"data":"Tesco","type":"ORG","mentions":7},{"data":"the Office for National Statistics","type":"ORG","mentions":4},{"data":"NHS","type":"ORG","mentions":2},{"data":"F&F","type":"ORG","mentions":2},{"data":"the Cottage Family Centre","type":"ORG","mentions":1},{"data":"Groundwork UK","type":"ORG","mentions":1},{"data":"F&F Premature Baby Essentials","type":"PRODUCT","mentions":1},{"data":"England","type":"GPE","mentions":2},{"data":"Wales","type":"GPE","mentions":1},{"data":"UK","type":"GPE","mentions":2},{"data":"Kirkcaldy","type":"GPE","mentions":1},{"data":"South Devon","type":"LOC","mentions":1}],"companies":[{"id":"39f3f5f9bcfe4aa2937f239f884e83f5","name":"Tesco Ireland","domains":["tesco.ie"],"symbols":[]},{"id":"a8d8b068ece24b06b2c74d5b5a2b587f","name":"Tesco PLC","domains":["tescoplc.com"],"symbols":["TSCDY","TSCO.L"]}],"sentiment":{"positive":0.38131997,"negative":0.17200029,"neutral":0.44667974},"summary":"Tesco has donated packs of premature baby clothing to Torbay Hospital neonatal unit in a bid to help with the care and support of premature babies and their families. The retailer has also delivered packs of F&F Premature Baby Essentials to the Tesco to help deliver the items. The Office for National Statistics estimates that on average, 7-10% of babies born in England and Wales are born prematurely. Tesco's head of Communities, Richard Beattie, commended the retailer's generous donations, stating that they want to provide practical help to mums and dads and help give premature babies a stronger start in life. The generous donations help The Salvation Army continue to assist people in need across the UK.","translation":"","translatedTitle":"","translatedDescription":"","translatedSummary":"","locations":[],"reprint":False,"reprintGroupId":"79d43469fcc04515ab4169ef5ed81db3","places":[],"people":[]},{"url":"https://bnnbreaking.com/finance-nav/business/tescos-strategic-wins-amid-uks-economic-challenges-profits-wages-and-inflation-insights","authorsByline":"Ebenezer Mensah","articleId":"e15d5f0be4ef46d3b0c50704273957ab","clusterId":"82bdcddfeceb4e3ead563fd0a6303ec0","source":{"domain":"bnnbreaking.com","location":None},"imageUrl":"https://img-cdn.thepublive.com/fit-in/1200x675/bnn/media/media_files/ed2049315ce38632edfdd0ffa8bec477a1a67ba86ac4155a67cad2d4f026996e.jpg","country":"us","language":"en","pubDate":"2024-03-05T06:09:21+00:00","addDate":"2024-03-05T06:18:58.379464+00:00","refreshDate":"2024-03-05T06:18:58.379466+00:00","score":47.587852,"title":"Tesco's Strategic Wins Amid UK's Economic Challenges: Profits, Wages, and Inflation Insights","description":"Tesco updates its operating profit to £2.75 billion, reflecting strategic successes and resilience amidst inflation and wage increases.","content":"Tesco PLC, a cornerstone of British retail, has recently updated its trading outlook, reflecting a nuanced understanding of the current economic landscape, including the impacts of minimum wage increases and inflation. The company has revised its operating profit expectations to approximately £2.75 billion, up from previous estimates, following a successful Christmas period and strategic operational adjustments.\n\nTesco's recent trading update, influenced by a robust Christmas season, has demonstrated the company's ability to navigate the complexities of the market. The retailer's focus on up-trading customers to its premium 'Finest' range, coupled with a profitable shift in its delivery services, has played a pivotal role in this upward revision of profit forecasts. This strategic maneuvering comes at a critical time when the UK faces a cost of living crisis, prompting Tesco to balance value for customers with its own profitability margins.\n\nThe backdrop to Tesco's operational adjustments is the significant increase in the UK's minimum wage, set to rise by over 9%. This change poses potential challenges to Tesco's profitability in the latter half of the fiscal year. However, Tesco's ability to foster customer loyalty through value offerings, even as it navigates wage inflation, underscores its resilience and adaptability. The company's efforts to stay behind inflation rates not only benefit consumers but also contribute positively to the broader UK inflation scenario.\n\nWhile Tesco's current performance and strategic decisions paint a promising picture, the road ahead is fraught with uncertainties, particularly concerning fuel costs and the broader economic climate. The retailer's success in maintaining a competitive edge, despite these challenges, will depend on its continued focus on operational efficiency and adaptability to market dynamics. Moreover, Tesco's acknowledgment of the competitive landscape and its potential to win market share indicate a strategic foresight critical for future growth.\n\nThe revised profit forecast and strategic successes of Tesco amidst economic challenges reflect not only the company's robust operational framework but also its acute awareness of the market dynamics at play. As Tesco continues to navigate the complexities of wage increases and inflation, its journey offers valuable insights into the resilience and adaptability necessary in today's ever-changing retail landscape.","medium":"Article","links":[],"labels":[],"matchedAuthors":[{"id":None,"name":"Ebenezer Mensah"}],"claim":"","verdict":"","keywords":[{"name":"wage inflation","weight":0.10512325},{"name":"minimum wage increases","weight":0.09518642},{"name":"Inflation Insights","weight":0.09361438},{"name":"wage increases","weight":0.09287866},{"name":"market dynamics","weight":0.08872394},{"name":"inflation rates","weight":0.08391471},{"name":"strategic operational adjustments","weight":0.08361403},{"name":"inflation","weight":0.08194066},{"name":"market share","weight":0.08048327},{"name":"economic challenges","weight":0.07774393}],"topics":[{"name":"Inflation"}],"categories":[{"name":"Business"}],"entities":[{"data":"Tesco","type":"ORG","mentions":11},{"data":"UK","type":"GPE","mentions":4},{"data":"British","type":"NORP","mentions":1}],"companies":[{"id":"39f3f5f9bcfe4aa2937f239f884e83f5","name":"Tesco Ireland","domains":["tesco.ie"],"symbols":[]},{"id":"a8d8b068ece24b06b2c74d5b5a2b587f","name":"Tesco PLC","domains":["tescoplc.com"],"symbols":["TSCDY","TSCO.L"]}],"sentiment":{"positive":0.82417744,"negative":0.030612765,"neutral":0.14520982},"summary":"Tesco PLC has updated its trading outlook, reflecting the current economic landscape, including the impacts of minimum wage increases and inflation. The company has revised its operating profit expectations to approximately £2.75 billion, up from previous estimates, following a successful Christmas period and strategic operational adjustments. The retailer's focus on increasing customers to its premium 'Finest' range and a profitable shift in its delivery services have contributed to this upward revision of profit forecasts. The increase in the UK's minimum wage, set to rise by over 9%, could pose challenges for Tesco's profitability in the latter half of the fiscal year. Despite these challenges, the retailer's success will depend on its continued focus on operational efficiency and adaptability to market dynamics. The revised profit forecast and strategic successes reflect the company's robust operational framework and awareness of the market dynamics at play.","translation":"","translatedTitle":"","translatedDescription":"","translatedSummary":"","locations":[],"reprint":False,"reprintGroupId":"9a2d5cd228d94ef99609f6e49491180c","places":[],"people":[]},{"url":"https://www.marketwatch.com/data-news/tesco-falls-monday-underperforms-market-540c5099-923c4b3f4c7d","authorsByline":"MarketWatch Automation","articleId":"ba3e0b0cf73e4067bc007f96f4651362","clusterId":"4bc79b0803b9447584b5e75669ffbdf5","source":{"domain":"marketwatch.com","paywall":True,"location":None},"imageUrl":"","country":"us","language":"en","pubDate":"2024-03-04T17:10:00+00:00","addDate":"2024-03-04T17:15:09.962565+00:00","refreshDate":"2024-03-04T17:15:09.962567+00:00","score":47.587852,"title":"Tesco falls Monday, underperforms market","description":"Shares of Tesco PLC inched down 0.61% to £2.76 Monday, on what proved to be an all-around poor trading session for the stock market, with the FTSE 100 Index...","content":"Shares of Tesco PLC TSCO, inched down 0.61% to £2.76 Monday, on what proved to be an all-around poor trading session for the stock market, with the FTSE 100 Index UKX, falling 0.55% to 7,640.33.\n\nTesco PLC closed 31.33 pence short of its 52-week high (£3.07), which the company achieved on March 8.\n\nTrading volume (7.5 M) remained 15.3 million below its 50-day average volume of 22.8 M. Editor's Note: This story was auto-generated by Automated Insights, an automation technology provider, using data from Dow Jones and FactSet. See our market data terms of use.","medium":"Article","links":["https://www.marketwatch.com/investing/stock/TSCO?countryCode=UK&mod=MW_story_quote","https://www.marketwatch.com/support/investing-terms-of-use?mod=article_inline","https://automatedinsights.com","https://www.marketwatch.com/investing/index/UKX?countryCode=UK&mod=MW_story_quote"],"labels":[],"matchedAuthors":[],"claim":"","verdict":"","keywords":[{"name":"Trading volume","weight":0.14462239},{"name":"market","weight":0.10611768},{"name":"Dow Jones","weight":0.0987123},{"name":"FactSet","weight":0.097756796},{"name":"use","weight":0.08749404},{"name":"March","weight":0.08681067},{"name":"data","weight":0.08374855},{"name":"Monday","weight":0.080067165},{"name":"Automated Insights","weight":0.07862151},{"name":"our market data terms","weight":0.076827936}],"topics":[{"name":"Markets"}],"categories":[{"name":"Finance"}],"entities":[{"data":"Tesco","type":"ORG","mentions":4},{"data":"Automated Insights","type":"ORG","mentions":1},{"data":"Dow Jones","type":"ORG","mentions":1},{"data":"FactSet","type":"ORG","mentions":1}],"companies":[{"id":"a8d8b068ece24b06b2c74d5b5a2b587f","name":"Tesco PLC","domains":["tescoplc.com"],"symbols":["TSCDY","TSCO.L"]},{"id":"39f3f5f9bcfe4aa2937f239f884e83f5","name":"Tesco Ireland","domains":["tesco.ie"],"symbols":[]}],"sentiment":{"positive":0.034128126,"negative":0.8284653,"neutral":0.13740656},"summary":"Shares of Tesco PLC fell by 0.61% to £2.76 on Monday, marking a poor trading session for the stock market. The FTSE 100 Index UKX also fell by a 0.55% to 7,640.33. Tesco closed 31.33 pence short of its 52-week high (£3.07), achieved on March 8. Trading volume remained 15.3 million below its 50-day average volume of 22.8 M.","translation":"","translatedTitle":"","translatedDescription":"","translatedSummary":"","locations":[],"reprint":True,"reprintGroupId":"970c13cee548493a90c3220e4542159d","places":[],"people":[]}]}, 200)
    
    return MockResponse(None, 404)


class TestPerigonService:
    """Test perigon news fetching"""

    @mock.patch('requests.get', side_effect=mocked_requests_get)
    def test_format(self, mocked_get):
        """Test the format of the return data"""
        result = perigon.getCompanyNewsPerigon('Tesco', 24, 3)

        assert len(result)==3
        for a in result:
            assert isinstance(a, Article)
        assert result[0].title=='Torbay Hospital neonatal unit receives premature baby clothing donation from Tesco'

    @mock.patch('requests.get', side_effect=mocked_requests_get)
    def test_errorhandle(self, mocked_get):
        with pytest.raises(APIError):
            perigon.getCompanyNewsPerigon('RANDOMTICKER', 56, 3)
    
    @mock.patch('requests.get', side_effect=mocked_requests_get)
    def test_dateProcessing(self, mocked_get: mock.MagicMock):
        """Test that the date subtraction is working correctly"""

        # mock an example date
        exampleDate = datetime.datetime(2024, 2, 27, 14, 45, 12)
        with mock.patch('services.PerigonService.datetime') as mock_datetime:
            mock_datetime.now.return_value = exampleDate
            perigon.getCompanyNewsPerigon('Apple', 24, 1)
            assert mocked_get.call_args.kwargs['params']['from'] == '2024-02-26'